#!/bin/bash
#set -x

#================================================================================
#================================================================================
# 

echo ''
echo 'Running the JJOB for PREP_LETKF, aka SOCA HoFx'
echo 'Date of Analysis: ' $CDATE
echo 'Run Directory: ' $RUNCDATE
echo ''

module purge
module use -a /scratch1/NCEPDEV/stmp4/Daniel.Holdaway/opt/modulefiles
module load apps/jedi/intel-19.0.5.281

rename_func () { for files in $1; do cp $files ${files:0:(${#files}-28)}'nc'; done }

# Rename the ensemble members
cd $RUNCDATE/Data

find -type l -delete
# Remove all softlinks before proceed
rename_func "cic.pert.ens.*.PT0S.nc"
rename_func "ocn.pert.ens.*.PT0S.nc"

cd $RUNCDATE

# Change of the coordinates
# TODO

# Get ENSBEG/ENSEND from ENSGRP and NMEM_EFCSGRP
export ENSEND=$((NMEM_PGRP * ENSGRP))
export ENSBEG=$((ENSEND - NMEM_PGRP + 1))

for MEMBER_NO in $(seq $ENSBEG $ENSEND); do
        echo $MEMBER_NO
        # Run H(x)
        srun -n $NPE ${SOCA_EXEC}/soca_hofx3d.x ./yaml/hofx3d$MEMBER_NO.yml
done
